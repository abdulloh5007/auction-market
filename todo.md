# TODO: Внутренняя покупка NFT через TON в Next.js проекте

## 1. Архитектура
- [ ] Определить структуру внутреннего кошелька пользователя
  - Хранить: user_id, ton_address, баланс, список внутренних NFT
- [ ] Решить, где хранить NFT: 
  - Внутри блокчейна (Jetton/NFT контракт) или как внутренняя запись (JSON, DB)
- [ ] Определить связи:
  - user ↔ internal_wallet ↔ purchased NFTs

---

## 2. Backend API (Next.js / API routes)
- [ ] Создать API route `/api/nft/buy`
  - Метод: POST
  - Параметры: user_id, nft_id
- [ ] Проверка баланса пользователя (TON)
  - Если недостаточно TON → возврат ошибки
- [ ] Вычисление стоимости NFT
  - Фиксированная цена или динамическая формула
- [ ] Создать транзакцию на списание TON
  - Использовать internal transfer TON на твой контракт / treasury
  - Важно: атомарная операция: списание → выдача NFT
- [ ] Обновление внутреннего кошелька пользователя
  - Добавление NFT в список владения
  - Списание TON
- [ ] API route `/api/nft/list`
  - Получение списка доступных NFT
- [ ] API route `/api/nft/my`
  - Получение NFT пользователя (internal wallet)

---

## 3. Работа с TON
- [ ] Подключение TON SDK (например `ton-core`, `ton-client-js`)
- [ ] Создание/подключение NFT контракта (Jetton/NFT)
- [ ] Генерация транзакции для покупки NFT
  - Передача TON → контракт NFT
  - Callback / Event: выдать NFT внутреннему кошельку
- [ ] Проверка успешности транзакции
  - Если успех → обновляем internal_wallet
  - Если неудача → откат списания TON
- [ ] Для testnet: использовать faucet для тестовых TON

---

## 4. Frontend (Next.js)
- [ ] Страница магазина NFT
  - Список доступных NFT
  - Кнопка “Купить” → вызывает `/api/nft/buy`
- [ ] Страница пользователя
  - Список NFT из внутреннего кошелька
  - Баланс TON
- [ ] Уведомления о покупке
  - Успешно / Ошибка / Транзакция в процессе
- [ ] Обновление состояния без перезагрузки (SWR, React Query)

---

## 5. Внутренний кошелек
- [ ] Создать таблицу/модель internal_wallet
  - user_id
  - ton_balance
  - nfts: JSON или relation
- [ ] Логирование транзакций
  - Чтобы можно было отследить историю покупок
- [ ] Безопасность
  - Проверка прав пользователя при списании
  - Проверка owner при выдаче NFT

---

## 6. Безопасность и проверка
- [ ] Проверка double-spend: один и тот же TON нельзя списать дважды
- [ ] Проверка атомарности: списание TON ↔ выдача NFT
- [ ] Логирование ошибок транзакций
- [ ] Ограничение частоты покупок (rate limit)
